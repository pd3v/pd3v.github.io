<!DOCTYPE html>
<html>
<head>
  <style>
  body {
    width:  100%;
    height: 100%;
    margin: 0px;
  }
  #top_bar {
    margin: 0px;
  }
  #title {
    font-family: "menlo", sans-serif;
    font-size: 40px;
    color: cyan;
    float: left;
  }
  #version {
    height: 40px;
    font-family: "verdana", sans-serif;
    font-size: 14px;
    color: cyan;
    line-height: 65px;
    margin-left: 5px;
    float: left;
  }
  #subtitle {
    font-family: "menlo", sans-serif;
    font-size: 30px;
    color: #777777;
    margin-left: 15px;
    line-height: 60px;
    float: left;
  }
  canvas {
    position: absolute;
    z-index: -1;
  }
  </style>
  
  <title>pd3v sounding code</title>
  <meta charset="UTF-8">
<body>
  <canvas id="colorCanvas"></canvas>
  <div id="top_bar">
    <div id="title">fluX</div>
    <div id="version">0.01</div>
    <div id="subtitle">sounding</div>
  </div>
  <!-- <div id="onOffBtt" width="100" height="100">AAA</div> -->
</body>
<script>

// Page layout
var c = document.getElementById("colorCanvas");
var ctx = c.getContext("2d");
ctx.canvas.width  = window.innerWidth;
ctx.canvas.height = window.innerHeight;

// Sound objects
var ac = new AudioContext();
var osc1 = ac.createOscillator();
var osc2 = ac.createOscillator();
var gainNode = ac.createGain();
var analyser = ac.createAnalyser();
var bufferLength = analyser.frequencyBinCount;
var dataArray = new Uint8Array(bufferLength);

var detune = 0.0;
var incDec = 1;

osc1.connect(gainNode);
osc1.type = 'sawtooth';
osc1.frequency.value = 220;

osc2.connect(gainNode);
osc2.type = 'triangle';
osc2.frequency.value = 330;

gainNode.connect(ac.destination);
gainNode.input = 2;
gainNode.gain.value = 0.5;

osc1.start();
osc2.start();

gainNode.connect(analyser);
analyser.fftSize = 2048;
analyser.getByteTimeDomainData(dataArray);

vectorSynthesis();
draw();

function draw() {
  var sliceWidth = ctx.canvas.width * 1.1 / bufferLength;
  var x = 0;
  
  drawVisual = requestAnimationFrame(draw);
  analyser.getByteTimeDomainData(dataArray);
  
  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);    
  ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  ctx.lineWidth = 1.5;
  ctx.strokeStyle = '#FFFFFF';
  ctx.beginPath();
  
  for(var i = 0; i < bufferLength; i++) { 
    var v = dataArray[i] / 128.0;
    var y = v * ctx.canvas.height/2;

    if(i === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }

    x += sliceWidth;
  }  
  ctx.lineTo(ctx.canvas.width, ctx.canvas.height);
  ctx.stroke();
};

function vectorSynthesis(){
  if (detune > 3) {
    incDec = -Math.random()*10;
  } else if (detune < -3){
    incDec = Math.random()*10;
  }

  detune += 1.0 * incDec;
  osc1.frequency.value -= detune;
  osc2.frequency.value += detune;

  setTimeout(vectorSynthesis, 100*Math.random()*Math.log(Math.random()*30));
}
</script>
</html>
